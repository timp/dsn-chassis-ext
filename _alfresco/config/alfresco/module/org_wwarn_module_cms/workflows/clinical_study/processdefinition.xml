<?xml version="1.0" encoding="UTF-8"?>

<process-definition  xmlns="urn:jbpm.org:jpdl-3.2"  name="ww:clinicalStudyProcess">
	<!--
         Assignees
         -->

    <swimlane name="initiator"/>
    
    <swimlane name="DataManagers">
        <assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
            <pooledactors>
                #{people.getGroup('GROUP_Data Managers')}
            </pooledactors>
        </assignment>
    </swimlane>
    
	<!--
         Workflow starts here
         -->

	<start-state name="Start">
		<task name="ww:startClinicalProcessTask" swimlane="initiator">
			<event type="task-create">
				<!-- This creates the ww_phase process variable -->
				<script>
					<variable name="ww_studyStatus" access="write"/>
					<expression>
						ww_studyStatus = "Initiated";
					</expression>
				</script>
			</event>
		</task>
	
		<transition to="GateKeeping/GT01_CheckStudy"></transition>
	</start-state>

	<super-state name="GateKeeping">
        <event type="superstate-enter">
            <script>
                <variable name="ww_studyStatus" access="write"/>
                <expression>
                    ww_studyStatus = "Gate Keeping";
                </expression>
            </script>
        </event>
	
		<task-node name="GT01_CheckStudy">
			<task name="ww:GT01_CheckStudyTask" swimlane="DataManagers" />
			<transition to="GT02_AssignCurator" name="OK"></transition>
			<transition to="GT03_AskForMoreStudyInfo" name="NotOK"></transition>
		</task-node>

		<task-node name="GT02_AssignCurator">
			<task name="ww:GT02_AssignCuratorTask" swimlane="DataManagers" />
			<transition to="GT04_AssignLiaison"></transition>
		</task-node>

		<task-node name="GT03_AskForMoreStudyInfo">
			<task name="ww:GT03_AskForMoreStudyInfoTask" swimlane="DataManagers" />
			<transition to="GT01_CheckStudy"></transition>
		</task-node>

		<task-node name="GT04_AssignLiaison">
			<task name="ww:GT04_AssignLiaisonTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="GT05_CompleteSSQ"></transition>
		</task-node>

		<task-node name="GT05_CompleteSSQ">
			<task name="ww:GT05_CompleteSSQTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="../Curation/CU01_CompleteMapping" name="OK"></transition>
			<transition to="GT06_ProvideSSQInfo" name="NeedMoreInfo"></transition>
		</task-node>

		<task-node name="GT06_ProvideSSQInfo">
			<task name="ww:GT06_ProvideSSQInfoTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeLiaison}</actor>
                </assignment>
			</task>
			<transition to="GT05_CompleteSSQ"></transition>
		</task-node>
	</super-state>

	<super-state name="Curation">
        <event type="superstate-enter">
            <script>
                <variable name="ww_studyStatus" access="write"/>
                <expression>
                    ww_studyStatus = "Curation";
                </expression>
            </script>
        </event>

		<task-node name="CU01_CompleteMapping">
			<task name="ww:CU01_CompleteMappingTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="CU02_RunProcessing" name="OK"></transition>
			<transition to="CU05_ResolveMappingProblem" name="HavaAProblem"></transition>
			<transition to="fork1" name="NeedMoreInfo"></transition>
		</task-node>

		<task-node name="CU02_RunProcessing">
			<task name="ww:CU02_RunProcessingTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="CU03_UploadOutputs" name="OK"></transition>
			<transition to="CU06_ResolveProcessingProblem" name="HavaAProblem"></transition>
		</task-node>

		<task-node name="CU03_UploadOutputs">
			<task name="ww:CU03_UploadOutputsTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="VA01_CuratorValidateOutputs"></transition>
		</task-node>

		<task-node name="CU04_ProvideMappingInfo">
			<task name="ww:CU04_ProvideMappingInfoTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeLiaison}</actor>
                </assignment>
			</task>
			<transition to="join1"></transition>
		</task-node>

		<task-node name="CU05_ResolveMappingProblem">
			<task name="ww:CU05_ResolveMappingProblemTask" swimlane="DataManagers" />
			<transition to="CU01_CompleteMapping"></transition>
		</task-node>

		<node name="EmailLiaisonAboutMappingInfoRequest">
			<transition to="join1"></transition>
		</node>

		<state name="Wait2Weeks">
			<transition to="EmailLiaisonAboutMappingInfoRequest"></transition>
		</state>

		<fork name="fork1">
			<transition to="Wait2Weeks" name="StartTimer"></transition>
			<transition to="CU04_ProvideMappingInfo" name="ProvideMappingInfo"></transition>
		</fork>

		<join name="join1">
			<transition to="CU01_CompleteMapping"></transition>
		</join>

		<task-node name="CU06_ResolveProcessingProblem">
			<task name="ww:CU06_ResolveProcessingProblemTask" swimlane="DataManagers" />
			<transition to="CU02_RunProcessing"></transition>
		</task-node>
	</super-state>

	<super-state name="Validation">
        <event type="superstate-enter">
            <script>
                <variable name="ww_studyStatus" access="write"/>
                <expression>
                    ww_studyStatus = "Validation";
                </expression>
            </script>
        </event>

		<task-node name="VA01_CuratorValidateOutputs">
			<task name="ww:VA01_CuratorValidateOutputsTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="VA02_DataManagerValidateOutputs" name="OK"></transition>
			<transition to="VA03_ResolveOutputsProblem" name="HavaAProblem"></transition>
		</task-node>

		<task-node name="VA02_DataManagerValidateOutputs">
			<task name="ww:VA02_DataManagerValidateOutputsTask" swimlane="DataManagers" />
			<transition to="VA03_ResolveOutputsProblem" name="HavaAProblem"></transition>
			<transition to="../Approval/AP01_AssignCentreHead" name="OK"></transition>
		</task-node>

		<task-node name="VA03_ResolveOutputsProblem">
			<task name="ww:VA03_ResolveOutputsProblemTask" swimlane="DataManagers" />
			<transition to="../Curation/CU05_ResolveMappingProblem" name="MappingProblem"></transition>
			<transition to="../Curation/CU06_ResolveProcessingProblem" name="ProcessorProblem"></transition>
		</task-node>
	</super-state>

	<super-state name="Approval">
        <event type="superstate-enter">
            <script>
                <variable name="ww_studyStatus" access="write"/>
                <expression>
                    ww_studyStatus = "Approval";
                </expression>
            </script>
        </event>

		<task-node name="AP01_AssignCentreHead">
			<task name="ww:AP01_AssignCentreHeadTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCurator}</actor>
                </assignment>
			</task>
			<transition to="AP02_CheckReport"></transition>
		</task-node>

		<task-node name="AP02_CheckReport">
			<task name="ww:AP02_CheckReportTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeCentreHead}</actor>
                </assignment>
			</task>
			<transition to="AP03_ProvideOutputsEmailInfo" name="OK"></transition>
			<transition to="../Validation/VA03_ResolveOutputsProblem" name="HavAProblem"></transition>
		</task-node>

		<node name="EmailContributorAboutOutputs">
			<transition to="AP04_ReceiveApproval"></transition>
		</node>

		<task-node name="AP03_ProvideOutputsEmailInfo">
			<task name="ww:AP03_ProvideOutputsEmailInfoTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeLiaison}</actor>
                </assignment>
			</task>
			<transition to="EmailContributorAboutOutputs"></transition>
		</task-node>

		<task-node name="AP04_ReceiveApproval">
			<task name="ww:AP04_ReceiveApprovalTask" >
			 	<assignment class="org.alfresco.repo.workflow.jbpm.AlfrescoAssignment">
                    <actor>#{ww_assigneeLiaison}</actor>
                </assignment>
			</task>
			<transition to="../Validation/VA03_ResolveOutputsProblem" name="Rejected"></transition>
			<transition to="AP05_SendOutputsToModule" name="ApprovedAndHide"></transition>
			<transition to="UploadToExplorer" name="ApprovedAndDisplay"></transition>
		</task-node>

		<task-node name="AP05_SendOutputsToModule">
			<task name="ww:AP05_SendOutputsToModuleTask" swimlane="DataManagers" />
			<transition to="../End"></transition>
		</task-node>

		<node name="UploadToExplorer">
			<transition to="AP05_SendOutputsToModule"></transition>
		</node>
	</super-state>

	<end-state name="End"></end-state>

</process-definition>